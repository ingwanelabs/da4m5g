#--------------------------------------------------------------------------------------
# SOLUTION: dimGeography
#--------------------------------------------------------------------------------------
dimGeography = (
    staging[['Country', 'City', 'State', 'Postal Code', 'Region']]
    .drop_duplicates(subset=['City', 'State'])
    .reset_index(drop=True)
)

dimGeography.insert(0, 'Geog_SK', range(1, len(dimGeography) + 1))

dimGeography.columns = ['Geog_SK', 'Country', 'City', 'State', 'PostalCode', 'Region']

print(f"dimGeography: {len(dimGeography):,} rows")
dimGeography.head()

#--------------------------------------------------------------------------------------
# SOLUTION - Question 1
#--------------------------------------------------------------------------------------
print(f"Staging rows      : {len(staging):,}")
print(f"Fact table rows   : {len(factOrderItem):,}")
print(f"Match             : {len(staging) == len(factOrderItem)}")
     

#--------------------------------------------------------------------------------------
# SOLUTION - Question 2
#--------------------------------------------------------------------------------------
print(f"Staging Quantity total      : {staging['Quantity'].sum():,}")
print(f"Fact table Quantity total   : {factOrderItem['Quantity'].sum():,}")
print(f"Match                       : {staging['Quantity'].sum() == factOrderItem['Quantity'].sum()}")
     

#--------------------------------------------------------------------------------------
# SOLUTION - Question 3
#--------------------------------------------------------------------------------------
print(f"Staging Profit total      : £{staging['Profit'].sum():,.2f}")
print(f"Fact table Profit total   : £{factOrderItem['Profit'].sum():,.2f}")
print(f"Match                     : {round(staging['Profit'].sum(),2) == round(factOrderItem['Profit'].sum(),2)}")
     

#--------------------------------------------------------------------------------------
# SOLUTION - Question 4: Sales by year
#--------------------------------------------------------------------------------------
# Merge fact with dimDate to get the Year, then group and sum

sales_by_year = (
    factOrderItem
    .merge(dimDate[['Date_SK', 'Year']], left_on='OrderDate_SK', right_on='Date_SK')
    .groupby('Year')['Sales']
    .sum()
    .reset_index()
    .sort_values('Sales', ascending=False)
)

print("Sales by Year:")
print(sales_by_year.to_string(index=False))

#--------------------------------------------------------------------------------------
